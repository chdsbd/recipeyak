FROM node:8.9.4 as builder

RUN mkdir -p /var/app

# Install package.json /var/ so we can mount at /app and not have issues with dependences
# http://stackoverflow.com/a/33106611/3555105
COPY package.json /var/
COPY yarn.lock /var/
WORKDIR /var/
RUN npm install -g yarn
RUN yarn install

WORKDIR /var/app
COPY . /var/app

ARG OAUTH_BITBUCKET_CLIENT_ID
ARG OAUTH_FACEBOOK_CLIENT_ID
ARG OAUTH_GITHUB_CLIENT_ID
ARG OAUTH_GITLAB_CLIENT_ID
ARG OAUTH_GOOGLE_CLIENT_ID
ARG FRONTEND_SENTRY_DSN
ARG GIT_SHA

# we use netcat to wait for a port to be avaiable
RUN apt-get update -yq && \
  apt-get install -yq netcat

# install chrome dependencies
RUN apt-get update -yq && \
  apt-get install -yq \
    gconf-service \
    libasound2 \
    libatk1.0-0 \
    libc6 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libexpat1 \
    libfontconfig1 \
    libgcc1 \
    libgconf-2-4 \
    libgdk-pixbuf2.0-0 \
    libglib2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libstdc++6 \
    libx11-6 \
    libx11-xcb1 \
    libxcb1 \
    libxcomposite1 \
    libxcursor1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxrandr2 \
    libxrender1 \
    libxss1 \
    libxtst6 \
    ca-certificates \
    fonts-liberation \
    libappindicator1 \
    libnss3 \
    lsb-release \
    xdg-utils \
    wget

RUN yarn build

FROM alpine:3.7
RUN mkdir -p /var/app/build
COPY --from=builder /var/app/build /var/app/build
COPY --from=builder /var/app/bootstrap.sh /var/app/
WORKDIR /var/app
