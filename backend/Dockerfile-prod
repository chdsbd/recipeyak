FROM python:3.6.4-alpine
ENV PYTHONUNBUFFERD 1

# we need libpq at runtime
# the following can probably be simplified
RUN apk add --no-cache --virtual .build-deps build-base postgresql-dev && \
    apk add --no-cache gcc git make libpq libffi-dev openssl-dev  \
      libffi openssl ca-certificates linux-headers musl-dev && \
    pip install psycopg2==2.7.3.2 cffi cryptography && \
    apk del .build-deps

# -- Install Pipenv:
RUN set -ex && pip install git+git://github.com/pypa/pipenv.git@8378a1b104f2d817790a05da370bef0a1b00f452

# -- Install Application into container:
RUN set -ex && mkdir -p /var/app

WORKDIR /var/app

# -- Adding Pipfiles
COPY Pipfile Pipfile
COPY Pipfile.lock Pipfile.lock

# -- Install dependencies:
RUN set -ex && pipenv install --dev --deploy --system

COPY . /var/app
RUN DOCKERBUILD=1 python manage.py collectstatic --noinput
ARG GIT_SHA
RUN sh -c 'sed -i s/\<%=GIT_SHA=%\>/"$GIT_SHA"/ backend/settings.py && grep GIT_SHA backend/settings.py'
