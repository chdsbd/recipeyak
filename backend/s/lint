#!/usr/bin/env bash
set -ex
set -o pipefail

format() {
  if [ "$CI" ]; then
    ./.venv/bin/ruff format . --check | grep  '^Would reformat:' |  awk -v prefix="$PWD" '{print "formatting-violation:" prefix "/" $3 ":formatting required"}'
  else
    ./.venv/bin/ruff format .
  fi
}

ruff() {
 if [ "$CI" ]; then
    ./.venv/bin/ruff . | grep -E '.*:\d+:\d+.*' | awk -v prefix="$PWD" '{print prefix "/" $0}'
  else
    ./.venv/bin/ruff . --fix
  fi
}

migrations() {
  if [ "$CI" ]; then
    ./s/check_migrations
  fi
}

typecheck() {
 if [ "$CI" ]; then
    ./s/typecheck | grep -E '.*:\d+:\d+.*' | awk -v prefix="$PWD" '{print prefix "/" $0}'
  else
    ./s/typecheck
  fi
}

main() {
  format
  ruff
  migrations
  typecheck
}

main "$@"
