#!/bin/bash

set -e

main() {
  # circle's built in git checkout code clobbers the `master` ref so we do the
  # following to make it not point to the current ref.
  # https://discuss.circleci.com/t/git-checkout-of-a-branch-destroys-local-reference-to-master/23781/7
  if [ "${CIRCLECI}" ]; then
    git branch -f master origin/master
  fi

  if ! command -v squawk &>/dev/null; then
    # allow root to install squawk globally
    npm config set unsafe-perm true
    echo "squawk not found, installing"
    npm i -g squawk-cli@0.1.4
  fi

  local changed_migration_files

  changed_migration_files=$(git --no-pager diff --name-only FETCH_HEAD master ./backend/core/migrations)

  echo $changed_migration_files

  for f in $changed_migration_files
  do
    echo "file"
    echo $f
  done

  squawk example.sql
}

main "${@}"
